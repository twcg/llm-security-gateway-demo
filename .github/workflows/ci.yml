name: CI

on:
  push:
  pull_request:

jobs:
  policy-and-demo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install conftest 0.56.0 + OPA 0.69.0 (Linux)
        shell: bash
        run: |
          set -euo pipefail
          CONFTEST_VERSION="0.56.0"
          OPA_VERSION="0.69.0"

          curl -sSL -o conftest.tar.gz "https://github.com/open-policy-agent/conftest/releases/download/v${CONFTEST_VERSION}/conftest_${CONFTEST_VERSION}_Linux_x86_64.tar.gz"
          tar -xzf conftest.tar.gz conftest
          sudo mv conftest /usr/local/bin/conftest

          curl -sSL -o opa "https://github.com/open-policy-agent/opa/releases/download/v${OPA_VERSION}/opa_linux_amd64_static"
          chmod +x opa
          sudo mv opa /usr/local/bin/opa

          conftest --version
          opa version

      - name: Make scripts executable
        run: |
          chmod +x scripts/demo.sh
          chmod +x tests/test_policies.sh

      - name: Run policy tests
        env:
          CONFTEST_BIN: conftest
        run: |
          ./tests/test_policies.sh

      - name: Run demo
        env:
          CONFTEST_BIN: conftest
        run: |
          ./scripts/demo.sh
